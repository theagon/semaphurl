<ui:FluentWindow x:Class="SemaphURL.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:vm="clr-namespace:SemaphURL.ViewModels"
        xmlns:models="clr-namespace:SemaphURL.Models"
        Title="SemaphURL Settings"
        Width="950" Height="750"
        MinWidth="750" MinHeight="550"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica"
        d:DataContext="{d:DesignInstance vm:MainViewModel}"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="SemaphURL" ShowMaximize="True" ShowMinimize="True">
            <ui:TitleBar.Icon>
                <ui:ImageIcon Source="/Assets/icon.png" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!-- Main Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24,16">
            <Grid>
                <StackPanel Visibility="{Binding IsAddingRule, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">

                    <!-- System Registration Section -->
                    <ui:CardExpander Header="System Registration" IsExpanded="True"
                                     Icon="{ui:SymbolIcon Shield24}">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,12"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}">
                                <Run Text="To intercept URLs, SemaphURL must be registered as a browser and set as default in Windows Settings." />
                            </TextBlock>

                            <!-- Registration Status -->
                            <Border CornerRadius="6" Padding="12" Margin="0,0,0,12">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="#1A22C55E" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRegistered}" Value="False">
                                                <Setter Property="Background" Value="#1AEF4444" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Margin="0,0,8,0">
                                        <ui:SymbolIcon.Style>
                                            <Style TargetType="ui:SymbolIcon">
                                                <Setter Property="Symbol" Value="CheckmarkCircle24" />
                                                <Setter Property="Foreground" Value="#22C55E" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsRegistered}" Value="False">
                                                        <Setter Property="Symbol" Value="ErrorCircle24" />
                                                        <Setter Property="Foreground" Value="#EF4444" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ui:SymbolIcon.Style>
                                    </ui:SymbolIcon>
                                    <TextBlock VerticalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="SemaphURL is registered in Windows" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsRegistered}" Value="False">
                                                        <Setter Property="Text" Value="SemaphURL is NOT registered - URLs won't be intercepted" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Border>

                            <!-- Action Buttons -->
                            <StackPanel Orientation="Horizontal">
                                <ui:Button Command="{Binding RegisterAsBrowserCommand}"
                                           Appearance="Primary"
                                           Margin="0,0,8,0">
                                    <ui:Button.Style>
                                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                            <Setter Property="Content" Value="Register as Browser" />
                                            <Setter Property="Icon" Value="{ui:SymbolIcon Shield24}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRunningAsAdmin}" Value="False">
                                                    <Setter Property="Content" Value="Register as Browser (Admin)" />
                                                    <Setter Property="Icon" Value="{ui:SymbolIcon ShieldKeyhole24}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Button.Style>
                                </ui:Button>
                                
                                <ui:Button Content="Open Default Apps"
                                           Icon="{ui:SymbolIcon Open24}"
                                           Command="{Binding OpenDefaultAppsSettingsCommand}"
                                           Margin="0,0,8,0" />
                                
                                <ui:Button Content="Unregister"
                                           Icon="{ui:SymbolIcon Delete24}"
                                           Command="{Binding UnregisterBrowserCommand}"
                                           Appearance="Secondary"
                                           Visibility="{Binding IsRegistered, Converter={StaticResource BoolToVisibilityConverter}}" />
                            </StackPanel>
                        </StackPanel>
                    </ui:CardExpander>

                    <!-- Default Browser Section -->
                    <ui:CardExpander Header="Default Browser" IsExpanded="True"
                                     Icon="{ui:SymbolIcon Globe24}"
                                     Margin="0,16,0,0">
                        <StackPanel>
                            <TextBlock Text="Used when no rules match the URL."
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                       TextWrapping="Wrap" Margin="0,0,0,12" />

                            <!-- Quick Select -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="Quick select:" VerticalAlignment="Center" Margin="0,0,8,0" />
                                <ComboBox x:Name="DefaultBrowserCombo"
                                          ItemsSource="{Binding InstalledBrowsers}"
                                          DisplayMemberPath="Name"
                                          MinWidth="200"
                                          SelectionChanged="OnDefaultBrowserSelectionChanged" />
                                <ui:Button Icon="{ui:SymbolIcon ArrowSync24}"
                                           Command="{Binding RefreshBrowsersCommand}"
                                           ToolTip="Refresh browser list"
                                           Margin="4,0,0,0" />
                            </StackPanel>
                            
                            <!-- Manual path -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <ui:TextBox Grid.Column="0"
                                            PlaceholderText="Path to browser executable..."
                                            Text="{Binding DefaultBrowserPath, UpdateSourceTrigger=PropertyChanged}" />
                                <ui:Button Grid.Column="1" Margin="8,0,0,0"
                                           Icon="{ui:SymbolIcon FolderOpen24}"
                                           Command="{Binding BrowseDefaultBrowserCommand}"
                                           ToolTip="Browse for browser" />
                            </Grid>
                        </StackPanel>
                    </ui:CardExpander>

                    <!-- Routing Rules by Browser Section -->
                    <ui:CardExpander Header="Routing Rules by Browser" IsExpanded="True"
                                     Icon="{ui:SymbolIcon ArrowRouting24}"
                                     Margin="0,16,0,0">
                        <StackPanel>
                            <!-- Toolbar -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <ui:Button Content="Add Rule"
                                           Icon="{ui:SymbolIcon Add24}"
                                           Command="{Binding StartAddingRuleCommand}"
                                           Appearance="Primary" />
                                <ui:Button Content="Refresh Browsers"
                                           Icon="{ui:SymbolIcon ArrowSync24}"
                                           Command="{Binding RefreshBrowsersCommand}"
                                           Margin="8,0,0,0" />
                            </StackPanel>

                            <!-- Browser Groups -->
                            <ItemsControl ItemsSource="{Binding BrowserGroups}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:BrowserGroupViewModel}">
                                        <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                                                CornerRadius="8"
                                                Margin="0,0,0,12"
                                                Padding="0">
                                            <Expander IsExpanded="{Binding IsExpanded}">
                                                <Expander.Header>
                                                    <StackPanel Orientation="Horizontal">
                                                        <Image Source="{Binding BrowserIcon}" 
                                                               Width="20" Height="20" 
                                                               Margin="0,0,10,0"
                                                               RenderOptions.BitmapScalingMode="HighQuality" />
                                                        <TextBlock Text="{Binding BrowserName}" 
                                                                   FontWeight="SemiBold"
                                                                   FontSize="14"
                                                                   VerticalAlignment="Center" />
                                                        <ui:Badge Content="{Binding RuleCount}"
                                                                  Appearance="Secondary"
                                                                  Margin="10,0,0,0" />
                                                    </StackPanel>
                                                </Expander.Header>
                                                <StackPanel Margin="8,8,8,8">
                                                    <!-- Rules for this browser -->
                                                    <ItemsControl ItemsSource="{Binding Rules}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate DataType="{x:Type vm:RuleViewModel}">
                                                                <Border Background="{ui:ThemeResource ControlFillColorSecondaryBrush}"
                                                                        CornerRadius="6"
                                                                        Padding="12,8"
                                                                        Margin="0,0,0,8">
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="*" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                        </Grid.ColumnDefinitions>

                                                                        <!-- Enable Toggle -->
                                                                        <ui:ToggleSwitch Grid.Column="0"
                                                                                         IsChecked="{Binding Enabled}"
                                                                                         VerticalAlignment="Center"
                                                                                         Margin="0,0,12,0" />

                                                                        <!-- Rule Info -->
                                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                            <StackPanel Orientation="Horizontal">
                                                                                <ui:TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                                                            PlaceholderText="Rule name"
                                                                                            MinWidth="150"
                                                                                            Margin="0,0,8,0" />
                                                                                <ComboBox ItemsSource="{Binding PatternTypes}"
                                                                                          SelectedItem="{Binding PatternType}"
                                                                                          MinWidth="130"
                                                                                          Margin="0,0,8,0" />
                                                                                <ui:TextBox Text="{Binding Pattern, UpdateSourceTrigger=PropertyChanged}"
                                                                                            PlaceholderText="Pattern..."
                                                                                            MinWidth="200" />
                                                                            </StackPanel>
                                                                        </StackPanel>

                                                                        <!-- Actions -->
                                                                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                                            <ui:Button Icon="{ui:SymbolIcon Copy24}"
                                                                                       ToolTip="Duplicate"
                                                                                       Command="{Binding DataContext.DuplicateRuleCommand, RelativeSource={RelativeSource AncestorType=ItemsControl, AncestorLevel=2}}"
                                                                                       CommandParameter="{Binding}"
                                                                                       Appearance="Secondary"
                                                                                       Margin="0,0,4,0" />
                                                                            <ui:Button Icon="{ui:SymbolIcon Delete24}"
                                                                                       ToolTip="Delete"
                                                                                       Command="{Binding DataContext.DeleteRuleCommand, RelativeSource={RelativeSource AncestorType=ItemsControl, AncestorLevel=2}}"
                                                                                       CommandParameter="{Binding}"
                                                                                       Appearance="Danger" />
                                                                        </StackPanel>
                                                                    </Grid>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>

                                                    <!-- Add rule to this browser button -->
                                                    <ui:Button Content="Add rule to this browser"
                                                               Icon="{ui:SymbolIcon Add24}"
                                                               Command="{Binding DataContext.AddRuleToBrowserCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                               CommandParameter="{Binding}"
                                                               Appearance="Secondary"
                                                               HorizontalAlignment="Left"
                                                               Margin="0,4,0,0" />
                                                </StackPanel>
                                            </Expander>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!-- Empty state -->
                            <TextBlock Text="No rules configured. Click 'Add Rule' to create your first routing rule."
                                       Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                       TextAlignment="Center"
                                       Margin="0,20"
                                       Visibility="{Binding BrowserGroups.Count, Converter={StaticResource CountToVisibilityConverter}}" />
                        </StackPanel>
                    </ui:CardExpander>

                    <!-- Test URL Section -->
                    <ui:CardExpander Header="Test URL Routing" IsExpanded="False"
                                     Icon="{ui:SymbolIcon BeakerEdit24}"
                                     Margin="0,16,0,0">
                        <StackPanel>
                            <TextBlock Text="Enter a URL to test which rule and browser would be used."
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                       TextWrapping="Wrap" Margin="0,0,0,12" />
                            
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                
                                <ui:TextBox Grid.Column="0"
                                            PlaceholderText="https://example.com/page"
                                            Text="{Binding TestUrl, UpdateSourceTrigger=PropertyChanged}" />
                                <ui:Button Grid.Column="1" Margin="8,0,0,0"
                                           Content="Test"
                                           Icon="{ui:SymbolIcon Play24}"
                                           Command="{Binding TestRoutingCommand}"
                                           Appearance="Primary" />
                            </Grid>

                            <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                                    CornerRadius="4"
                                    Padding="12"
                                    Visibility="{Binding TestResult, Converter={StaticResource StringToVisibilityConverter}, FallbackValue=Collapsed}">
                                <TextBlock Text="{Binding TestResult}"
                                           FontFamily="Consolas"
                                           TextWrapping="Wrap" />
                            </Border>
                        </StackPanel>
                    </ui:CardExpander>

                    <!-- Settings Section -->
                    <ui:CardExpander Header="Application Settings" IsExpanded="False"
                                     Icon="{ui:SymbolIcon Settings24}"
                                     Margin="0,16,0,0">
                        <StackPanel>
                            <ui:CardControl Margin="0,0,0,12">
                                <ui:CardControl.Header>
                                    <StackPanel>
                                        <TextBlock Text="Start with Windows" />
                                        <TextBlock Text="Launch SemaphURL when Windows starts"
                                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                   FontSize="12" />
                                    </StackPanel>
                                </ui:CardControl.Header>
                                <ui:ToggleSwitch IsChecked="{Binding StartWithWindows}" />
                            </ui:CardControl>

                            <ui:CardControl Margin="0,0,0,12">
                                <ui:CardControl.Header>
                                    <StackPanel>
                                        <TextBlock Text="Minimize to tray on close" />
                                        <TextBlock Text="Keep running in system tray when window is closed"
                                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                   FontSize="12" />
                                    </StackPanel>
                                </ui:CardControl.Header>
                                <ui:ToggleSwitch IsChecked="{Binding MinimizeToTrayOnClose}" />
                            </ui:CardControl>

                            <ui:CardControl Margin="0,0,0,12">
                                <ui:CardControl.Header>
                                    <StackPanel>
                                        <TextBlock Text="Start minimized" />
                                        <TextBlock Text="Start in system tray without showing window"
                                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                   FontSize="12" />
                                    </StackPanel>
                                </ui:CardControl.Header>
                                <ui:ToggleSwitch IsChecked="{Binding StartMinimized}" />
                            </ui:CardControl>

                            <ui:CardControl Margin="0,0,0,12">
                                <ui:CardControl.Header>
                                    <StackPanel>
                                        <TextBlock Text="Show notifications" />
                                        <TextBlock Text="Show tray notification when URL is routed"
                                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                   FontSize="12" />
                                    </StackPanel>
                                </ui:CardControl.Header>
                                <ui:ToggleSwitch IsChecked="{Binding ShowNotifications}" />
                            </ui:CardControl>

                            <ui:Button Content="Open Config Folder"
                                       Icon="{ui:SymbolIcon Folder24}"
                                       Command="{Binding OpenConfigFolderCommand}"
                                       HorizontalAlignment="Left" />
                        </StackPanel>
                    </ui:CardExpander>

                    <!-- Favorite Sites Section -->
                    <ui:CardExpander Header="Favorite Sites" IsExpanded="False"
                                     Icon="{ui:SymbolIcon Star24}"
                                     Margin="0,16,0,0">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,12"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}">
                                <Run Text="Quick access to your favorite sites. Press " />
                                <Run Text="Ctrl+Space" FontWeight="SemiBold" />
                                <Run Text=" anywhere to open the Favorite Sites panel." />
                            </TextBlock>

                            <ui:Button Content="Open Favorite Sites"
                                       Icon="{ui:SymbolIcon Star24}"
                                       Command="{Binding OpenFavoriteSitesCommand}"
                                       Appearance="Primary"
                                       HorizontalAlignment="Left" />
                        </StackPanel>
                    </ui:CardExpander>

                    <!-- URL History Section -->
                    <ui:CardExpander Header="URL History" IsExpanded="False"
                                     Icon="{ui:SymbolIcon History24}"
                                     Margin="0,16,0,0">
                        <StackPanel>
                            <TextBlock TextWrapping="Wrap" Margin="0,0,0,12"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}">
                                <Run Text="View all URLs that have been routed through SemaphURL. Right-click on any entry to quickly create a routing rule." />
                            </TextBlock>

                            <ui:Button Content="Open URL History"
                                       Icon="{ui:SymbolIcon History24}"
                                       Command="{Binding OpenUrlHistoryCommand}"
                                       Appearance="Primary"
                                       HorizontalAlignment="Left" />
                        </StackPanel>
                    </ui:CardExpander>

                </StackPanel>

                <!-- Add Rule Dialog Overlay -->
                <Border Background="#E0181825"
                        Visibility="{Binding IsAddingRule, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                            CornerRadius="12"
                            Padding="24"
                            MaxWidth="500"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                        <StackPanel>
                            <TextBlock Text="Add New Rule"
                                       FontSize="20"
                                       FontWeight="SemiBold"
                                       Margin="0,0,0,20" />

                            <!-- Browser Selection -->
                            <TextBlock Text="Browser" Margin="0,0,0,8" />
                            <ComboBox ItemsSource="{Binding InstalledBrowsers}"
                                      SelectedItem="{Binding NewRuleBrowser}"
                                      MinWidth="300"
                                      Margin="0,0,0,16">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate DataType="{x:Type models:InstalledBrowser}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <!-- Rule Name -->
                            <TextBlock Text="Rule Name" Margin="0,0,0,8" />
                            <ui:TextBox Text="{Binding NewRuleName, UpdateSourceTrigger=PropertyChanged}"
                                        PlaceholderText="e.g., YouTube Videos"
                                        Margin="0,0,0,16" />

                            <!-- Pattern Type -->
                            <TextBlock Text="Pattern Type" Margin="0,0,0,8" />
                            <ComboBox ItemsSource="{Binding PatternTypes}"
                                      SelectedItem="{Binding NewRulePatternType}"
                                      Margin="0,0,0,16" />

                            <!-- Pattern -->
                            <TextBlock Text="Pattern" Margin="0,0,0,8" />
                            <ui:TextBox Text="{Binding NewRulePattern, UpdateSourceTrigger=PropertyChanged}"
                                        PlaceholderText="e.g., youtube.com"
                                        Margin="0,0,0,24" />

                            <!-- Buttons -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <ui:Button Content="Cancel"
                                           Command="{Binding CancelAddingRuleCommand}"
                                           Appearance="Secondary"
                                           Margin="0,0,8,0" />
                                <ui:Button Content="Add Rule"
                                           Icon="{ui:SymbolIcon Add24}"
                                           Command="{Binding ConfirmAddRuleCommand}"
                                           Appearance="Primary" />
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Border>
            </Grid>
        </ScrollViewer>

        <!-- Bottom Bar -->
        <Border Grid.Row="2" 
                Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="24,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <ui:SymbolIcon Symbol="Info24" Margin="0,0,8,0" />
                    <TextBlock Text="{Binding StatusMessage}"
                               VerticalAlignment="Center" />
                    <TextBlock Text=" â€¢ " Visibility="{Binding HasUnsavedChanges, Converter={StaticResource BoolToVisibilityConverter}}" />
                    <TextBlock Text="Unsaved changes" 
                               Foreground="{ui:ThemeResource SystemFillColorCautionBrush}"
                               Visibility="{Binding HasUnsavedChanges, Converter={StaticResource BoolToVisibilityConverter}}" />
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <ui:Button Content="Reload"
                               Icon="{ui:SymbolIcon ArrowSync24}"
                               Command="{Binding ReloadCommand}"
                               Margin="0,0,8,0" />
                    <ui:Button Content="Save"
                               Icon="{ui:SymbolIcon Save24}"
                               Command="{Binding SaveCommand}"
                               Appearance="Primary" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>
