<ui:FluentWindow x:Class="SemaphURL.Views.UrlHistoryWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:vm="clr-namespace:SemaphURL.ViewModels"
        xmlns:models="clr-namespace:SemaphURL.Models"
        Title="URL History"
        Width="900" Height="600"
        MinWidth="700" MinHeight="400"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica"
        d:DataContext="{d:DesignInstance vm:UrlHistoryViewModel}"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="URL History" ShowMaximize="True" ShowMinimize="True">
            <ui:TitleBar.Icon>
                <ui:SymbolIcon Symbol="History24" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!-- Main Content -->
        <Grid Grid.Row="1" Margin="16">
            <!-- History List View -->
            <Grid>
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsCreatingRule}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Search and Actions Bar -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <ui:TextBox Grid.Column="0"
                                PlaceholderText="Search by URL, domain, browser, or rule..."
                                Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                Icon="{ui:SymbolIcon Search24}" />

                    <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0">
                        <ui:Button Icon="{ui:SymbolIcon ArrowSync24}"
                                   ToolTip="Refresh"
                                   Command="{Binding RefreshCommand}"
                                   Margin="0,0,4,0" />
                        <ui:Button Icon="{ui:SymbolIcon Delete24}"
                                   ToolTip="Clear History"
                                   Command="{Binding ClearHistoryCommand}"
                                   Appearance="Danger" />
                    </StackPanel>
                </Grid>

                <!-- History Table -->
                <Border Grid.Row="1"
                        Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                        CornerRadius="8">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="8">
                        <ItemsControl ItemsSource="{Binding FilteredEntries}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{ui:ThemeResource ControlFillColorSecondaryBrush}"
                                            CornerRadius="6"
                                            Padding="12,10"
                                            Margin="0,0,0,8"
                                            Cursor="Hand">
                                        <Border.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Create Rule from Domain"
                                                          Command="{Binding CreateRuleFromDomainCommand}" />
                                                <Separator />
                                                <MenuItem Header="Copy URL"
                                                          Command="{Binding CopyUrlCommand}" />
                                                <MenuItem Header="Open URL"
                                                          Command="{Binding OpenUrlCommand}" />
                                                <Separator />
                                                <MenuItem Header="Delete"
                                                          Command="{Binding DeleteCommand}" />
                                            </ContextMenu>
                                        </Border.ContextMenu>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Date/Time -->
                                            <StackPanel Grid.Column="0" Margin="0,0,16,0" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding DateFormatted}"
                                                           FontSize="12"
                                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" />
                                                <TextBlock Text="{Binding TimeFormatted}"
                                                           FontSize="11"
                                                           Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}" />
                                            </StackPanel>
                                            
                                            <!-- Domain and URL -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Domain}"
                                                           FontWeight="SemiBold"
                                                           FontSize="14"
                                                           Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" />
                                                <TextBlock Text="{Binding UrlTruncated}"
                                                           ToolTip="{Binding Url}"
                                                           FontSize="12"
                                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                           TextTrimming="CharacterEllipsis" />
                                            </StackPanel>
                                            
                                            <!-- Browser and Rule -->
                                            <StackPanel Grid.Column="2" Margin="16,0,0,0" VerticalAlignment="Center" HorizontalAlignment="Right">
                                                <TextBlock Text="{Binding BrowserName}"
                                                           FontSize="12"
                                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                                           HorizontalAlignment="Right" />
                                                <TextBlock Text="{Binding RuleNameDisplay}"
                                                           FontSize="11"
                                                           Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                                           HorizontalAlignment="Right" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>

                <!-- Empty State -->
                <StackPanel Grid.Row="1"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Visibility="{Binding FilteredEntries.Count, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding FilteredEntries.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <ui:SymbolIcon Symbol="History24"
                                   FontSize="48"
                                   Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                                   Margin="0,0,0,16" />
                    <TextBlock Text="No URL history"
                               Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                               FontSize="16"
                               TextAlignment="Center" />
                    <TextBlock Text="URLs will appear here as you browse"
                               Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"
                               FontSize="13"
                               TextAlignment="Center"
                               Margin="0,8,0,0" />
                </StackPanel>
            </Grid>

            <!-- Create Rule Dialog -->
            <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                    CornerRadius="12"
                    Padding="24"
                    MaxWidth="450"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    Visibility="{Binding IsCreatingRule, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <TextBlock Text="Create Rule from History"
                               FontSize="20"
                               FontWeight="SemiBold"
                               Margin="0,0,0,8" />
                    
                    <TextBlock Text="{Binding SelectedEntry.Url}"
                               Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                               TextTrimming="CharacterEllipsis"
                               Margin="0,0,0,20" />

                    <!-- Rule Name -->
                    <TextBlock Text="Rule Name" Margin="0,0,0,8" />
                    <ui:TextBox Text="{Binding NewRuleName, UpdateSourceTrigger=PropertyChanged}"
                                PlaceholderText="e.g., YouTube Videos"
                                Margin="0,0,0,16" />

                    <!-- Pattern Type -->
                    <TextBlock Text="Pattern Type" Margin="0,0,0,8" />
                    <ComboBox ItemsSource="{Binding AvailablePatternTypes}"
                              SelectedItem="{Binding NewRulePatternType}"
                              Margin="0,0,0,16" />

                    <!-- Pattern -->
                    <TextBlock Text="Pattern" Margin="0,0,0,8" />
                    <ui:TextBox Text="{Binding NewRulePattern, UpdateSourceTrigger=PropertyChanged}"
                                PlaceholderText="e.g., youtube.com"
                                Margin="0,0,0,16" />

                    <!-- Browser Selection -->
                    <TextBlock Text="Browser" Margin="0,0,0,8" />
                    <ComboBox ItemsSource="{Binding InstalledBrowsers}"
                              SelectedItem="{Binding SelectedBrowser}"
                              DisplayMemberPath="Name"
                              Margin="0,0,0,24" />

                    <!-- Buttons -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <ui:Button Content="Cancel"
                                   Command="{Binding CancelCreateRuleCommand}"
                                   Appearance="Secondary"
                                   Margin="0,0,8,0" />
                        <ui:Button Content="Create Rule"
                                   Icon="{ui:SymbolIcon Add24}"
                                   Command="{Binding ConfirmCreateRuleCommand}"
                                   Appearance="Primary" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2"
                Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <ui:SymbolIcon Symbol="Info24" Margin="0,0,8,0" />
                    <TextBlock Text="{Binding StatusMessage}" />
                </StackPanel>

                <ui:Button Grid.Column="1"
                           Content="Close"
                           Command="{Binding CloseCommand}" />
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>

